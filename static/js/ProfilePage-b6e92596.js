import{e as I}from"./index-da62fde9.js";import{_ as E,U as l,u as N,N as f,C as b,m as V,j as P,r as _,o as p,c as h,d as u,a as d,t as g,b as i,w as o,g as w,f as D}from"./index-fb2654cf.js";const K={name:"ProfilePage",components:{},data(){return{e:I,u:l,chainStore:N(),needUpdateInfo:{bVisible:!1,expiredStamp:"",type:0},kvPairTableData:[],renewalDialog:{bVisible:!1,priceUnit:0,lifetimeUnit:0,renewalPeriods:1,cost:2,newExpiredStamp:0},editData:{bVisible:!1,avatar:"",minRow:0,tableData:[]}}},async mounted(){let e=this;l.registerEventByType("resolveAddress",function(a){e.updateUI()}),l.registerEventByType("namespaceReady",function(a){f.resolveAddressFull(e.chainStore.address)}),e.updateUI(),f.resolveAddressFull(this.chainStore.address)},methods:{async updateUI(){const e=this.chainStore.resolveAddressResult,a=this.chainStore.getNamespaceInfo(e.namespace);a&&(this.needUpdateInfo.bVisible=!0,a.renewalLifetime>0||a.pingLifetime>0?(this.needUpdateInfo.expiredStamp=(a.renewalLifetime>0?e.renewalExpiredStamp:e.pingExpiredStamp).toNumber(),a.renewalLifetime>0?this.needUpdateInfo.type=1:this.needUpdateInfo.type=2):(this.needUpdateInfo.type=0,this.needUpdateInfo.expiredStamp=0),this.kvPairTableData.splice(0,this.kvPairTableData.length),this.kvPairTableData.push(...f.genNameKVPairTableData(e)))},async onClickRenewal(){const e=this.chainStore.resolveAddressResult,a=this.chainStore.getNamespaceInfo(e.namespace);if(!a)return;const n=await this.chainStore.getNameContract().getRenewalPrice(l.str2Bytes32(e.namespace),l.str2Bytes32(e.name));if(!n[0]){l.alert("Internal error(renewal price)");return}this.renewalDialog.priceUnit=n[1],this.renewalDialog.lifetimeUnit=a.renewalLifetime.toNumber(),this.renewalDialog.renewalPeriods=1,this.renewalDialog.newExpiredStamp=0,this.renewalDialog.cost=0,this.updateRenewalPrice(),this.renewalDialog.bVisible=!0},updateRenewalPrice(){let e=this.renewalDialog;e.cost=e.priceUnit.mul(e.renewalPeriods),e.newExpiredStamp=this.needUpdateInfo.expiredStamp+e.renewalPeriods*e.lifetimeUnit},async onClickSureRenewal(){if((await b.getBalance(this.chainStore.address)).lte(this.renewalDialog.cost)){l.alert("Balance unenough");return}const a=this.chainStore.resolveAddressResult;let n=this;b.callExternal(async function(v){return n.renewalDialog.bVisible=!1,await v.renewal(l.str2Bytes32(a.namespace),l.str2Bytes32(a.name),n.renewalDialog.renewalPeriods,{value:n.renewalDialog.cost})},function(v){v.status==1&&(l.alert("Renewal success"),f.resolveAddressFull(n.chainStore.address))})},async onClickPing(){const e=this.chainStore.resolveAddressResult;let a=this;b.callExternal(async function(n){return await n.ping(l.str2Bytes32(e.namespace),l.str2Bytes32(e.name))},function(n){n.status==1&&(l.alert("Ping success"),f.resolveAddressFull(a.chainStore.address))})},onClickTransfer(){const e=this.chainStore.resolveAddressResult;let a=this;V.prompt("Input receiver address",`Transfer ${e.fullName}`,{confirmButtonText:"OK",cancelButtonText:"Cancel",inputPattern:/^0x[0-9|a-z|A-Z]{40}$/,inputErrorMessage:"Invalid address"}).then(({value:n})=>{a.doTransferName(n)})},async doTransferName(e){if(!e)return;const a=await this.chainStore.getNameContract().resolveAddress(e);if(a.bResult){l.alert(`One address can only own one name, receiver already own ${l.bytes32ToStr(a.name)}.${l.bytes32ToStr(a.namespace)}!`);return}const n=this.chainStore.resolveAddressResult;let v=this;b.callExternal(async function(t){return await t.transferFrom(v.chainStore.address,e,n.tokenId)},function(t){t.status==1?(l.alert("Transfer success"),f.resolveAddressFull(v.chainStore.address)):l.alert("Transfer fail")})},onClickEditProfile(){const e=this.chainStore.resolveAddressResult;let a=this.editData;a.avatar=e.avatar,a.tableData.splice(0,a.tableData.length);const n=f.genNameKVPairTableData(e);a.minRow=n.length,a.tableData.push(...n),a.bVisible=!0},isSpecialKey(e){return f.isSpecialKey(e)},getSpecialKeyCount(){return f.getSpecialKeys().length},onProfileValueChange(e){e.name=="avatar"&&(this.editData.avatar=e.value)},onClickAddRecord(){this.editData.tableData.push({name:"",value:""})},async onClickSaveEdit(){await f.resolveAddressFull(this.chainStore.address);const e=this.chainStore.resolveAddressResult;let a=[],n=[],v=[],t=this.editData.tableData,c={};for(let m=0;m<t.length;m++){const s=t[m];if(s.name=s.name.trim(),s.name==""){l.alert(`Name can't be empty(line ${m+1})`);return}if(c[s.name]!==void 0){l.alert(`Duplicate name(line ${c[s.name]+1} == line ${m+1}, both are ${s.name})`);return}if(c[s.name]=m,s.value&&(s.value=s.value.trim()),s.value&&s.value.length>=128){l.alert(`Content length exceeds 128!(line ${m+1})`);return}const k=e.profileKeyList.indexOf(s.name);k==-1?s.value!==void 0&&s.value.length!=0&&(a.push(0),n.push(l.str2Bytes32(s.name)),v.push(P(s.value))):s.value!=e.kvMap[s.name]&&(a.push(k+1),n.push(l.str2Bytes32(s.name)),v.push(P(s.value)))}if(a.length==0){l.alert("No change");return}let C=this;b.callExternal(async function(m){return await m.setProfileKeyValuePairs(l.str2Bytes32(e.namespace),l.str2Bytes32(e.name),a,n,v)},function(m){m.status==1&&(C.editData.bVisible=!1,l.alert("Edit profile success"),f.resolveAddressFull(C.chainStore.address))})},onClickCancel(){this.editData.bVisible=!1},onClickClearProfile(){let e=this;V.confirm("Clear profile?","Warning",{type:"warning",confirmButtonText:"OK",cancelButtonText:"Cancel"}).then(()=>{e.sureRemoveAllKV()})},sureRemoveAllKV(){const e=this.chainStore.resolveAddressResult;let a=this;b.callExternal(async function(n){return await n.removeAllProfileKeys(l.str2Bytes32(e.namespace),l.str2Bytes32(e.name))},function(n){n.status==1&&(a.editData.bVisible=!1,l.alert("Clear profile success"),f.resolveAddressFull(a.chainStore.address))})}}},L={id:"main"},F={id:"subTitle"},H={key:0},M={key:1},z={key:0,style:{"margin-top":"64px"}},O={key:1},W={key:0},j={key:1},Z={key:2},q=["innerHTML"],G={key:3},J={key:0,style:{"margin-top":"8px","font-size":"15px"}},Q={style:{"margin-top":"16px"}},X={key:2},Y={key:0},$={style:{"margin-top":"16px"}},ee={style:{"margin-top":"16px"}},te={style:{"margin-top":"16px"}},ae={style:{"margin-top":"16px"}};function le(e,a,n,v,t,c){const C=_("router-link"),m=_("el-avatar"),s=_("el-table-column"),k=_("el-link"),x=_("el-table"),y=_("el-button"),U=_("el-tooltip"),R=_("el-input"),B=_("el-space"),A=_("el-input-number"),T=_("el-dialog");return p(),h("div",null,[u("div",L,[u("div",F,[t.editData.bVisible?(p(),h("div",M," Edit "+g(t.chainStore.resolveAddressResult.fullName),1)):(p(),h("div",H,[d(" Welcome: "),u("span",null,g(t.chainStore.resolveAddressResult.bResult?t.chainStore.resolveAddressResult.fullName:t.chainStore.address),1)]))]),t.chainStore.resolveAddressResult.bResult?w("",!0):(p(),h("div",z,[d(" Current address doesn't hold name yet, go to "),i(C,{to:"/",replace:""},{default:o(()=>[d("register")]),_:1})])),t.chainStore.resolveAddressResult.bResult&&!t.editData.bVisible?(p(),h("div",O,[i(m,{style:{"margin-top":"32px"},size:100,src:t.chainStore.resolveAddressResult.avatar},null,8,["src"]),i(x,{data:t.kvPairTableData,style:{width:"660px",margin:"20px auto"},stripe:"",border:""},{default:o(()=>[i(s,{prop:"name",label:"Name",width:"120",align:"center"}),i(s,{label:"Content"},{default:o(r=>[r.row.bAddress?(p(),h("div",W,[i(k,{class:"elink",href:"https://etherscan.io/address/"+r.row.value,target:"_blank"},{default:o(()=>[d(g(r.row.value),1)]),_:2},1032,["href"])])):r.row.bLink?(p(),h("div",j,[i(k,{class:"elink",href:r.row.value,target:"_blank"},{default:o(()=>[d(g(r.row.value),1)]),_:2},1032,["href"])])):r.row.bHtml?(p(),h("div",Z,[u("div",{innerHTML:r.row.value},null,8,q)])):(p(),h("div",G,g(r.row.value),1))]),_:1})]),_:1},8,["data"]),t.needUpdateInfo.bVisible?(p(),h("div",J,[d(" Expired date: "),u("strong",null,g(t.needUpdateInfo.expiredStamp==0?"Never expired":t.u.formatTime(t.needUpdateInfo.expiredStamp)),1)])):w("",!0),u("div",Q,[i(y,{class:"actBtn",type:"primary",plain:"",onClick:c.onClickEditProfile},{default:o(()=>[d("Edit profile")]),_:1},8,["onClick"]),t.needUpdateInfo.bVisible&&t.needUpdateInfo.type==1?(p(),D(y,{key:0,class:"actBtn",type:"primary",plain:"",onClick:c.onClickRenewal},{default:o(()=>[d("Renewal")]),_:1},8,["onClick"])):w("",!0),t.needUpdateInfo.bVisible&&t.needUpdateInfo.type==2?(p(),D(y,{key:1,class:"actBtn",type:"primary",plain:"",onClick:c.onClickPing},{default:o(()=>[d("Ping(free)")]),_:1},8,["onClick"])):w("",!0),i(y,{class:"actBtn",type:"primary",plain:"",onClick:c.onClickTransfer},{default:o(()=>[d("Transfer")]),_:1},8,["onClick"])])])):w("",!0),t.editData.bVisible?(p(),h("div",X,[u("div",null,[i(U,{effect:"dark",content:"Will refresh when change the avatar field below",placement:"top"},{default:o(()=>[i(m,{style:{"margin-top":"32px"},size:100,src:t.editData.avatar},null,8,["src"])]),_:1})]),i(B,{direction:"vertical",alignment:"start"},{default:o(()=>[i(x,{data:t.editData.tableData,style:{width:"660px",margin:"20px auto 4px auto"},stripe:"",border:""},{default:o(()=>[i(s,{type:"index",width:"50",align:"center"}),i(s,{prop:"name",label:"Name",width:"120",align:"center"},{default:o(r=>[c.isSpecialKey(r.row.name)?(p(),h("span",Y,g(r.row.name),1)):(p(),D(R,{key:1,modelValue:r.row.name,"onUpdate:modelValue":S=>r.row.name=S},null,8,["modelValue","onUpdate:modelValue"]))]),_:1}),i(s,{label:"Content"},{default:o(r=>[i(R,{modelValue:r.row.value,"onUpdate:modelValue":S=>r.row.value=S,onChange:S=>c.onProfileValueChange(r.row)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1})]),_:1},8,["data"]),u("div",null,[i(y,{type:"primary",plain:"",onClick:c.onClickAddRecord,disabled:t.editData.tableData.length>=200},{default:o(()=>[d("Add")]),_:1},8,["onClick","disabled"]),i(y,{type:"info",plain:"",onClick:a[0]||(a[0]=r=>t.editData.tableData.splice(t.editData.tableData.length-1)),disabled:t.editData.tableData.length<=t.editData.minRow},{default:o(()=>[d("Remove last")]),_:1},8,["disabled"])])]),_:1}),u("div",$,[i(y,{class:"actBtn",type:"primary",onClick:c.onClickSaveEdit},{default:o(()=>[d("Save")]),_:1},8,["onClick"]),i(y,{class:"actBtn",type:"info",onClick:c.onClickCancel},{default:o(()=>[d("Cancel")]),_:1},8,["onClick"]),i(y,{class:"actBtn",type:"danger",onClick:c.onClickClearProfile},{default:o(()=>[d("Clear")]),_:1},8,["onClick"])])])):w("",!0)]),i(T,{modelValue:t.renewalDialog.bVisible,"onUpdate:modelValue":a[2]||(a[2]=r=>t.renewalDialog.bVisible=r),title:"Renewal "+t.chainStore.resolveAddressResult.fullName,width:"550px","align-center":""},{footer:o(()=>[i(y,{type:"primary",onClick:c.onClickSureRenewal},{default:o(()=>[d("Renewal")]),_:1},8,["onClick"])]),default:o(()=>[u("div",null,[d("Expired date currently: "),u("strong",null,g(t.u.formatTime(t.needUpdateInfo.expiredStamp)),1)]),u("div",ee,[d(" Select renewal periods: "),i(A,{style:{"margin-left":"4px"},min:1,max:20,modelValue:t.renewalDialog.renewalPeriods,"onUpdate:modelValue":a[1]||(a[1]=r=>t.renewalDialog.renewalPeriods=r),onChange:c.updateRenewalPrice},null,8,["modelValue","onChange"])]),u("div",te,[d("Expired date after renewal: "),u("strong",null,g(t.u.formatTime(t.renewalDialog.newExpiredStamp)),1)]),u("div",ae,[d("Cost: "),u("strong",null,g(t.u.float2Str(t.e.utils.formatEther(t.renewalDialog.cost)))+" eth",1)])]),_:1},8,["modelValue","title"])])}const ie=E(K,[["render",le],["__scopeId","data-v-9285f70b"]]);export{ie as default};
