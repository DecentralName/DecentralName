import{e as I}from"./index-4541571d.js";import{_ as E,U as l,u as N,N as f,m as V,j as P,r as v,o as m,c as _,d as u,a as d,t as g,b as i,w as r,g as b,f as D}from"./index-ef42d13c.js";import{C as w}from"./ChainHelper-98299809.js";const K={name:"ProfilePage",components:{},data(){return{e:I,u:l,chainStore:N(),needUpdateInfo:{bVisible:!1,expiredStamp:"",type:0},kvPairTableData:[],renewalDialog:{bVisible:!1,priceUnit:0,lifetimeUnit:0,renewalPeriods:1,cost:2,newExpiredStamp:0},editData:{bVisible:!1,avatar:"",minRow:0,tableData:[]}}},async mounted(){let e=this;l.registerEventByType("resolveAddress",function(a){e.updateUI()}),l.registerEventByType("namespaceReady",function(a){f.resolveAddressFull(e.chainStore.address)}),e.updateUI(),f.resolveAddressFull(this.chainStore.address)},methods:{async updateUI(){const e=this.chainStore.resolveAddressResult,a=this.chainStore.getNamespaceInfo(e.namespace);a&&(this.needUpdateInfo.bVisible=!0,a.renewalLifetime>0||a.pingLifetime>0?(this.needUpdateInfo.expiredStamp=(a.renewalLifetime>0?e.renewalExpiredStamp:e.pingExpiredStamp).toNumber(),a.renewalLifetime>0?this.needUpdateInfo.type=1:this.needUpdateInfo.type=2):(this.needUpdateInfo.type=0,this.needUpdateInfo.expiredStamp=0),this.kvPairTableData.splice(0,this.kvPairTableData.length),this.kvPairTableData.push(...f.genNameKVPairTableData(e)))},async onClickRenewal(){const e=this.chainStore.resolveAddressResult,a=this.chainStore.getNamespaceInfo(e.namespace);if(!a)return;const n=await this.chainStore.getNameContract().getRenewalPrice(l.str2Bytes32(e.namespace),l.str2Bytes32(e.name));if(!n[0]){l.alert("Internal error(renewal price)");return}this.renewalDialog.priceUnit=n[1],this.renewalDialog.lifetimeUnit=a.renewalLifetime.toNumber(),this.renewalDialog.renewalPeriods=1,this.renewalDialog.newExpiredStamp=0,this.renewalDialog.cost=0,this.updateRenewalPrice(),this.renewalDialog.bVisible=!0},updateRenewalPrice(){let e=this.renewalDialog;e.cost=e.priceUnit.mul(e.renewalPeriods),e.newExpiredStamp=this.needUpdateInfo.expiredStamp+e.renewalPeriods*e.lifetimeUnit},async onClickSureRenewal(){if((await w.getBalance(this.chainStore.address)).lte(this.renewalDialog.cost)){l.alert("Balance unenough");return}const a=this.chainStore.resolveAddressResult;let n=this;w.callExternal(async function(h){return n.renewalDialog.bVisible=!1,await h.renewal(l.str2Bytes32(a.namespace),l.str2Bytes32(a.name),n.renewalDialog.renewalPeriods,{value:n.renewalDialog.cost})},function(h){h.status==1&&(l.alert("Renewal success"),f.resolveAddressFull(n.chainStore.address))})},async onClickPing(){const e=this.chainStore.resolveAddressResult;let a=this;w.callExternal(async function(n){return await n.ping(l.str2Bytes32(e.namespace),l.str2Bytes32(e.name))},function(n){n.status==1&&(l.alert("Ping success"),f.resolveAddressFull(a.chainStore.address))})},onClickTransfer(){const e=this.chainStore.resolveAddressResult;let a=this;V.prompt("Input receiver address",`Transfer ${e.fullName}`,{confirmButtonText:"OK",cancelButtonText:"Cancel",inputPattern:/^0x[0-9|a-z|A-Z]{40}$/,inputErrorMessage:"Invalid address"}).then(({value:n})=>{a.doTransferName(n)})},async doTransferName(e){if(!e)return;const a=await this.chainStore.getNameContract().resolveAddress(e);if(a.bResult){l.alert(`One address can only own one name, receiver already own ${l.bytes32ToStr(a.name)}.${l.bytes32ToStr(a.namespace)}!`);return}const n=this.chainStore.resolveAddressResult;let h=this;w.callExternal(async function(t){return await t.transferFrom(h.chainStore.address,e,n.tokenId)},function(t){t.status==1?(l.alert("Transfer success"),f.resolveAddressFull(h.chainStore.address)):l.alert("Transfer fail")})},onClickEditProfile(){const e=this.chainStore.resolveAddressResult;let a=this.editData;a.avatar=e.avatar,a.tableData.splice(0,a.tableData.length);const n=f.genNameKVPairTableData(e);a.minRow=n.length,a.tableData.push(...n),a.bVisible=!0},isSpecialKey(e){return f.isSpecialKey(e)},getSpecialKeyCount(){return f.getSpecialKeys().length},onProfileValueChange(e){e.name=="avatar"&&(this.editData.avatar=e.value)},onClickAddRecord(){this.editData.tableData.push({name:"",value:""})},async onClickSaveEdit(){await f.resolveAddressFull(this.chainStore.address);const e=this.chainStore.resolveAddressResult;let a=[],n=[],h=[],t=this.editData.tableData,c={};for(let p=0;p<t.length;p++){const s=t[p];if(s.name=s.name.trim(),s.name==""){l.alert(`Name can't be empty(line ${p+1})`);return}if(c[s.name]!==void 0){l.alert(`Duplicate name(line ${c[s.name]+1} == line ${p+1}, both are ${s.name})`);return}if(c[s.name]=p,s.value&&(s.value=s.value.trim()),s.value&&s.value.length>=128){l.alert(`Content length exceeds 128!(line ${p+1})`);return}const C=e.profileKeyList.indexOf(s.name);C==-1?s.value!==void 0&&s.value.length!=0&&(a.push(0),n.push(l.str2Bytes32(s.name)),h.push(P(s.value))):s.value!=e.kvMap[s.name]&&(a.push(C+1),n.push(l.str2Bytes32(s.name)),h.push(P(s.value)))}if(a.length==0){l.alert("No change");return}let k=this;w.callExternal(async function(p){return await p.setProfileKeyValuePairs(l.str2Bytes32(e.namespace),l.str2Bytes32(e.name),a,n,h)},function(p){p.status==1&&(k.editData.bVisible=!1,l.alert("Edit profile success"),f.resolveAddressFull(k.chainStore.address))})},onClickCancel(){this.editData.bVisible=!1},onClickClearProfile(){let e=this;V.confirm("Clear profile?","Warning",{type:"warning",confirmButtonText:"OK",cancelButtonText:"Cancel"}).then(()=>{e.sureRemoveAllKV()})},sureRemoveAllKV(){const e=this.chainStore.resolveAddressResult;let a=this;w.callExternal(async function(n){return await n.removeAllProfileKeys(l.str2Bytes32(e.namespace),l.str2Bytes32(e.name))},function(n){n.status==1&&(a.editData.bVisible=!1,l.alert("Clear profile success"),f.resolveAddressFull(a.chainStore.address))})}}},L={id:"main"},F={id:"subTitle"},H={key:0},M={key:1},z={key:0,style:{"margin-top":"64px"}},O={key:1},W={key:0},j={key:1},Z=["innerHTML"],q={key:2},G={key:0,style:{"margin-top":"8px","font-size":"15px"}},J={style:{"margin-top":"16px"}},Q={key:2},X={key:0},Y={style:{"margin-top":"16px"}},$={style:{"margin-top":"16px"}},ee={style:{"margin-top":"16px"}},te={style:{"margin-top":"16px"}};function ae(e,a,n,h,t,c){const k=v("router-link"),p=v("el-avatar"),s=v("el-table-column"),C=v("el-link"),x=v("el-table"),y=v("el-button"),U=v("el-tooltip"),R=v("el-input"),B=v("el-space"),A=v("el-input-number"),T=v("el-dialog");return m(),_("div",null,[u("div",L,[u("div",F,[t.editData.bVisible?(m(),_("div",M," Edit "+g(t.chainStore.resolveAddressResult.fullName),1)):(m(),_("div",H,[d(" Welcome: "),u("span",null,g(t.chainStore.resolveAddressResult.bResult?t.chainStore.resolveAddressResult.fullName:t.chainStore.address),1)]))]),t.chainStore.resolveAddressResult.bResult?b("",!0):(m(),_("div",z,[d(" Current address doesn't hold name yet, go to "),i(k,{to:"/",replace:""},{default:r(()=>[d("register")]),_:1})])),t.chainStore.resolveAddressResult.bResult&&!t.editData.bVisible?(m(),_("div",O,[i(p,{style:{"margin-top":"32px"},size:100,src:t.chainStore.resolveAddressResult.avatar},null,8,["src"]),i(x,{data:t.kvPairTableData,style:{width:"660px",margin:"20px auto"},stripe:"",border:""},{default:r(()=>[i(s,{prop:"name",label:"Name",width:"120",align:"center"}),i(s,{label:"Content"},{default:r(o=>[o.row.bAddress?(m(),_("div",W,[i(C,{class:"elink",href:"https://etherscan.io/address/"+o.row.value,target:"_blank"},{default:r(()=>[d(g(o.row.value),1)]),_:2},1032,["href"])])):o.row.bHtml?(m(),_("div",j,[u("div",{innerHTML:o.row.value},null,8,Z)])):(m(),_("div",q,g(o.row.value),1))]),_:1})]),_:1},8,["data"]),t.needUpdateInfo.bVisible?(m(),_("div",G,[d(" Expired date: "),u("strong",null,g(t.needUpdateInfo.expiredStamp==0?"Never expired":t.u.formatTime(t.needUpdateInfo.expiredStamp)),1)])):b("",!0),u("div",J,[i(y,{class:"actBtn",type:"primary",plain:"",onClick:c.onClickEditProfile},{default:r(()=>[d("Edit profile")]),_:1},8,["onClick"]),t.needUpdateInfo.bVisible&&t.needUpdateInfo.type==1?(m(),D(y,{key:0,class:"actBtn",type:"primary",plain:"",onClick:c.onClickRenewal},{default:r(()=>[d("Renewal")]),_:1},8,["onClick"])):b("",!0),t.needUpdateInfo.bVisible&&t.needUpdateInfo.type==2?(m(),D(y,{key:1,class:"actBtn",type:"primary",plain:"",onClick:c.onClickPing},{default:r(()=>[d("Ping(free)")]),_:1},8,["onClick"])):b("",!0),i(y,{class:"actBtn",type:"primary",plain:"",onClick:c.onClickTransfer},{default:r(()=>[d("Transfer")]),_:1},8,["onClick"])])])):b("",!0),t.editData.bVisible?(m(),_("div",Q,[u("div",null,[i(U,{effect:"dark",content:"Will refresh when change the avatar field below",placement:"top"},{default:r(()=>[i(p,{style:{"margin-top":"32px"},size:100,src:t.editData.avatar},null,8,["src"])]),_:1})]),i(B,{direction:"vertical",alignment:"start"},{default:r(()=>[i(x,{data:t.editData.tableData,style:{width:"660px",margin:"20px auto 4px auto"},stripe:"",border:""},{default:r(()=>[i(s,{type:"index",width:"50",align:"center"}),i(s,{prop:"name",label:"Name",width:"120",align:"center"},{default:r(o=>[c.isSpecialKey(o.row.name)?(m(),_("span",X,g(o.row.name),1)):(m(),D(R,{key:1,modelValue:o.row.name,"onUpdate:modelValue":S=>o.row.name=S},null,8,["modelValue","onUpdate:modelValue"]))]),_:1}),i(s,{label:"Content"},{default:r(o=>[i(R,{modelValue:o.row.value,"onUpdate:modelValue":S=>o.row.value=S,onChange:S=>c.onProfileValueChange(o.row)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1})]),_:1},8,["data"]),u("div",null,[i(y,{type:"primary",plain:"",onClick:c.onClickAddRecord,disabled:t.editData.tableData.length>=200},{default:r(()=>[d("Add")]),_:1},8,["onClick","disabled"]),i(y,{type:"info",plain:"",onClick:a[0]||(a[0]=o=>t.editData.tableData.splice(t.editData.tableData.length-1)),disabled:t.editData.tableData.length<=t.editData.minRow},{default:r(()=>[d("Remove last")]),_:1},8,["disabled"])])]),_:1}),u("div",Y,[i(y,{class:"actBtn",type:"primary",onClick:c.onClickSaveEdit},{default:r(()=>[d("Save")]),_:1},8,["onClick"]),i(y,{class:"actBtn",type:"info",onClick:c.onClickCancel},{default:r(()=>[d("Cancel")]),_:1},8,["onClick"]),i(y,{class:"actBtn",type:"danger",onClick:c.onClickClearProfile},{default:r(()=>[d("Clear")]),_:1},8,["onClick"])])])):b("",!0)]),i(T,{modelValue:t.renewalDialog.bVisible,"onUpdate:modelValue":a[2]||(a[2]=o=>t.renewalDialog.bVisible=o),title:"Renewal "+t.chainStore.resolveAddressResult.fullName,width:"550px","align-center":""},{footer:r(()=>[i(y,{type:"primary",onClick:c.onClickSureRenewal},{default:r(()=>[d("Renewal")]),_:1},8,["onClick"])]),default:r(()=>[u("div",null,[d("Expired date currently: "),u("strong",null,g(t.u.formatTime(t.needUpdateInfo.expiredStamp)),1)]),u("div",$,[d(" Select renewal periods: "),i(A,{style:{"margin-left":"4px"},min:1,max:20,modelValue:t.renewalDialog.renewalPeriods,"onUpdate:modelValue":a[1]||(a[1]=o=>t.renewalDialog.renewalPeriods=o),onChange:c.updateRenewalPrice},null,8,["modelValue","onChange"])]),u("div",ee,[d("Expired date after renewal: "),u("strong",null,g(t.u.formatTime(t.renewalDialog.newExpiredStamp)),1)]),u("div",te,[d("Cost: "),u("strong",null,g(t.u.float2Str(t.e.utils.formatEther(t.renewalDialog.cost)))+" eth",1)])]),_:1},8,["modelValue","title"])])}const ie=E(K,[["render",ae],["__scopeId","data-v-951cb0b3"]]);export{ie as default};
